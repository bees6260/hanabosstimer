<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>哈娜RO Boss計時器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        #eventLog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 10px;
            margin: 0;
            z-index: 100;
        }

        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        .log-content {
            flex-grow: 1;
            font-size: 14px;
            line-height: 1.2;
        }

        .log-actions {
            display: flex;
            gap: 5px;
        }

        .log-actions button {
            padding: 2px 8px;
            font-size: 12px;
            background: #666;
        }

        .log-actions button:hover {
            background: #777;
        }

        #eventLogActions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 5px;
            border-bottom: 1px solid #555;
            margin-bottom: 5px;
        }

        #eventLogActions button {
            background: #666;
            font-size: 14px;
        }

        .cancel-btn {
            background: #ff4444 !important;
        }

        .cancel-btn:hover {
            background: #ff6666 !important;
        }

        .search-container {
            position: fixed;
            top: var(--event-log-height, 160px);
            left: 0;
            right: 0;
            background: #fff;
            padding: 10px;
            z-index: 99;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #searchInput {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 0 auto;
            display: block;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .category-title {
            width: 100%;
            padding: 10px;
            background: #333;
            color: white;
            margin: 10px 0;
            border-radius: 4px;
        }

        .timer {
            color: #ff4444;
            font-weight: bold;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: calc(var(--event-log-height, 160px) + 100px);
        }

        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            width: 250px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card.hidden {
            display: none;
        }

        .card h3 {
            margin: 10px 0;
            font-size: 16px;
        }

        .controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #45a049;
        }

        input[type="datetime-local"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .mvp-section,
        .poring-section {
            width: 100%;
        }

        .input-time-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .page-title {
            text-align: center;
            position: fixed;
            top: calc(var(--event-log-height, 160px) + 60px);
            left: 0;
            right: 0;
            z-index: 98;
        }

        .page-title h1 {
            margin: 0;
            padding: 10px;
            color: #333;
            font-size: 24px;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        // 在此填入您的 Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyC9hw8fywmpeKUfS7TuFcP6bgpeL9t_25I",
            authDomain: "ro-boss-timer.firebaseapp.com",
            projectId: "ro-boss-timer",
            storageBucket: "ro-boss-timer.firebasestorage.app",
            messagingSenderId: "743569692128",
            appId: "1:743569692128:web:92c439c1c58a9c6801c785",
            measurementId: "G-T39L35DDV0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const bosses = [
            { category: "MVP", name: "1039 巴風特", respawnTime: 3600000 },
            { category: "MVP", name: "1046 死靈(吉分)", respawnTime: 3600000 },
            { category: "MVP", name: "1046 死靈(地下)", respawnTime: 3600000 },
            { category: "MVP", name: "1059 蜂后", respawnTime: 3600000 },
            { category: "MVP", name: "1086 黃金蟲", respawnTime: 3600000 },
            { category: "MVP", name: "1087 獸人英雄1", respawnTime: 3600000 },
            { category: "MVP", name: "1087 獸人英雄2", respawnTime: 3600000 },
            { category: "MVP", name: "1112 海盜之王", respawnTime: 3600000 },
            { category: "MVP", name: "1115 虎王", respawnTime: 3600000 },
            { category: "MVP", name: "1147 蟻后", respawnTime: 3600000 },
            { category: "MVP", name: "1150 月夜貓", respawnTime: 3600000 },
            { category: "MVP", name: "1157 法老王", respawnTime: 3600000 },
            { category: "MVP", name: "1159 皮里恩", respawnTime: 3600000 },
            { category: "MVP", name: "1181 殭屍龍", respawnTime: 3600000 },
            { category: "MVP", name: "1190 獸人酋長", respawnTime: 3600000 },
            { category: "MVP", name: "1251 冰暴騎士", respawnTime: 3600000 },
            { category: "MVP", name: "1252 卡崙", respawnTime: 3600000 },
            { category: "MVP", name: "1272 黑暗之王(古墓)", respawnTime: 3600000 },
            { category: "MVP", name: "1272 黑暗之王(地下)", respawnTime: 3600000 },
            { category: "MVP", name: "1289 狂暴蟻后", respawnTime: 3600000 },
            { category: "MVP", name: "1312 烏龜將軍", respawnTime: 3600000 },
            { category: "MVP", name: "1373 死靈騎士", respawnTime: 3600000 },
            { category: "MVP", name: "1389 德古拉男爵", respawnTime: 3600000 },
            { category: "MVP", name: "1418 墨蛇君", respawnTime: 3600000 },
            { category: "MVP", name: "1492 元靈武士", respawnTime: 3600000 },
            { category: "MVP", name: "1511 古埃及王", respawnTime: 3600000 },
            { category: "MVP", name: "1518 白素貞", respawnTime: 3600000 },
            { category: "MVP", name: "1583 塔奧群卡", respawnTime: 3600000 },
            { category: "MVP", name: "1623 RSX-0806", respawnTime: 3600000 },
            { category: "MVP", name: "1685 貝思波", respawnTime: 3600000 },
            { category: "MVP", name: "1688 嗒妮小姐", respawnTime: 3600000 },
            { category: "MVP", name: "1708 魔劍士達納托斯的記憶", respawnTime: 3600000 },
            { category: "MVP", name: "1719 迪塔勒泰晤勒斯", respawnTime: 3600000 },
            { category: "MVP", name: "1734 齊爾-D-01", respawnTime: 3600000 },
            { category: "MVP", name: "1768 幽暗夢魘", respawnTime: 3600000 },
            { category: "MVP", name: "1871 墮落大神官悉潘", respawnTime: 3600000 },
            { category: "MVP", name: "1873 貝雷傑", respawnTime: 3600000 },
            { category: "MVP", name: "1874 詛咒蠅王", respawnTime: 3600000 },
            { category: "波利家族", name: "1096 天波(朱原3)", respawnTime: 3600000 },
            { category: "波利家族", name: "1096 天波(斐原4)", respawnTime: 3600000 },
            { category: "波利家族", name: "1120 幽波(沉船2)", respawnTime: 3600000 },
            { category: "波利家族", name: "1120 幽波(迷藏3)", respawnTime: 3600000 },
            { category: "波利家族", name: "1120 幽波(斐原4)", respawnTime: 3600000 },
            { category: "波利家族", name: "1120 幽波(公會4)", respawnTime: 3600000 },
            { category: "波利家族", name: "1388 聖天波(朱原5)", respawnTime: 3600000 },
            { category: "波利家族", name: "1582 惡波(斐原4)", respawnTime: 3600000 },
            { category: "波利家族", name: "1582 惡波(朱原3)", respawnTime: 3600000 }
        ];

        let bossTimers = [];
        let currentBossIndex = null;

        async function loadEventsFromFirebase() {
            const snapshot = await getDocs(collection(db, 'bossEvents'));
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const bossIndex = bosses.findIndex(b => b.name === data.bossName);
                if (bossIndex !== -1) {
                    const killTime = new Date(data.killTime);
                    const respawnTime = new Date(data.respawnTime);
                    addToEventLog(data.bossName, killTime, respawnTime, docSnap.id);
                    startTimer(bossIndex, killTime, respawnTime, docSnap.id);
                }
            });
        }

        function generateCards() {
            const mvpContainer = document.querySelector('.mvp-section .cards-container');
            const poringContainer = document.querySelector('.poring-section .cards-container');

            bosses.forEach((boss, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${boss.name}</h3>
                    <div class="controls">
                        <button onclick="recordKill(${index})">記錄擊殺</button>
                        <button onclick="openTimeDialog(${index})">輸入擊殺時間</button>
                        <button onclick="openCountdownDialog(${index})">輸入倒數時間</button>
                    </div>
                `;

                if (boss.category === "MVP") {
                    mvpContainer.appendChild(card);
                } else {
                    poringContainer.appendChild(card);
                }
            });
        }

        // 因為使用module, window.onload觸發前會定義全局函式需加在window上:
        window.openTimeDialog = function (bossIndex) {
            currentBossIndex = bossIndex;
            const dialog = document.getElementById('timeDialog');
            const overlay = document.getElementById('overlay');
            const dialogBossName = document.getElementById('dialogBossName');
            const dialogTimeInput = document.getElementById('dialogTimeInput');

            dialogBossName.textContent = bosses[bossIndex].name;

            // 使用本地時間，而非toISOString()
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const timeString = `${year}-${month}-${day}T${hours}:${minutes}`;
            dialogTimeInput.value = timeString;

            dialog.style.display = 'block';
            overlay.style.display = 'block';
        };

        window.closeTimeDialog = function () {
            const dialog = document.getElementById('timeDialog');
            const overlay = document.getElementById('overlay');
            dialog.style.display = 'none';
            overlay.style.display = 'none';
            currentBossIndex = null;
        };

        window.confirmCustomTime = async function () {
            const timeInput = document.getElementById('dialogTimeInput');
            const customDate = new Date(timeInput.value);
            if (currentBossIndex !== null) {
                await updateBossTimer(currentBossIndex, customDate);
            }
            closeTimeDialog();
        }

        window.recordKill = async function (bossIndex) {
            const now = new Date();
            await updateBossTimer(bossIndex, now);
        }

        async function updateBossTimer(bossIndex, killTime) {
            const boss = bosses[bossIndex];
            const respawnTime = new Date(killTime.getTime() + boss.respawnTime);

            const docRef = await addDoc(collection(db, 'bossEvents'), {
                bossName: boss.name,
                killTime: killTime.toISOString(),
                respawnTime: respawnTime.toISOString()
            });

            addToEventLog(boss.name, killTime, respawnTime, docRef.id);
            startTimer(bossIndex, killTime, respawnTime, docRef.id);
        }

        function startTimer(bossIndex, killTime, respawnTime, docId) {
            if (bossTimers[bossIndex]) {
                clearInterval(bossTimers[bossIndex]);
            }

            bossTimers[bossIndex] = setInterval(() => {
                const now = new Date();
                const timeLeft = respawnTime - now;

                if (timeLeft <= 0) {
                    clearInterval(bossTimers[bossIndex]);
                    updateEventLogTimer(bosses[bossIndex].name, "已重生!");
                } else {
                    const hours = Math.floor(timeLeft / (60 * 60 * 1000));
                    const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                    const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
                    updateEventLogTimer(bosses[bossIndex].name,
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                    );
                }
            }, 1000);
        }

        function addToEventLog(bossName, killTime, respawnTime, docId) {
            const logDiv = document.getElementById('eventLogContent');
            const logId = `log-${bossName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const logItem = document.createElement('div');
            logItem.id = logId;
            logItem.className = 'log-item';
            logItem.setAttribute('data-doc-id', docId);
            logItem.innerHTML = `
                <div class="log-content">
                    ${bossName} - 
                    擊殺: ${killTime.toLocaleString()} | 
                    重生: ${respawnTime.toLocaleString()} | 
                    倒數: <span class="timer">計算中...</span>
                </div>
                <div class="log-actions">
                    <button class="cancel-btn" onclick="cancelEvent('${logId}')">取消</button>
                </div>
            `;

            const existingLog = document.getElementById(logId);
            if (existingLog) {
                existingLog.innerHTML = logItem.innerHTML;
                existingLog.setAttribute('data-doc-id', docId);
            } else {
                logDiv.appendChild(logItem);
            }

            updateEventLogHeight();
        }

        window.cancelEvent = async function (logId) {
            const logItem = document.getElementById(logId);
            if (logItem) {
                const docId = logItem.getAttribute('data-doc-id');
                await deleteDoc(doc(db, 'bossEvents', docId));

                logItem.remove();
                const bossName = logId.replace(/^log-/, '');
                const bossIndex = bosses.findIndex(b => b.name.replace(/[^a-zA-Z0-9]/g, '') === bossName);

                if (bossIndex >= 0 && bossTimers[bossIndex]) {
                    clearInterval(bossTimers[bossIndex]);
                    bossTimers[bossIndex] = null;
                }
            }
        }

        window.copyAllEvents = function () {
            const logContent = document.getElementById('eventLogContent');
            let textToCopy = '';
            const logItems = logContent.getElementsByClassName('log-item');

            for (const item of logItems) {
                const content = item.querySelector('.log-content').textContent;
                const parts = content.split('|');
                if (parts.length >= 2) {
                    const bossName = parts[0].split(' - ')[0].trim();
                    const respawnTime = parts[1].replace('重生:', '').trim();
                    textToCopy += `${bossName} - ${respawnTime}\n`;
                }
            }

            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert('已複製所有事件到剪貼簿');
                }).catch(err => {
                    console.error('複製失敗:', err);
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('已複製所有事件到剪貼簿');
                });
            } else {
                alert('沒有可複製的事件');
            }
        }

        function updateEventLogTimer(bossName, timeString) {
            const logId = `log-${bossName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const logItem = document.getElementById(logId);
            if (logItem) {
                const timerSpan = logItem.querySelector('.timer');
                if (timerSpan) {
                    timerSpan.textContent = timeString;
                }
            }
        }

        function updateEventLogHeight() {
            const eventLog = document.getElementById('eventLog');
            const height = eventLog.offsetHeight;
            document.documentElement.style.setProperty('--event-log-height', `${height}px`);
        }
        let currentBossIndexForCountdown = null;

        window.openCountdownDialog = function (bossIndex) {
            currentBossIndexForCountdown = bossIndex;
            const dialog = document.getElementById('countdownDialog');
            const overlay = document.getElementById('overlay');
            const dialogBossName = document.getElementById('countdownDialogBossName');
            const countdownInput = document.getElementById('countdownInput');

            dialogBossName.textContent = bosses[bossIndex].name;
            countdownInput.value = 30; // 預設30分鐘或您想給的預設值

            dialog.style.display = 'block';
            overlay.style.display = 'block';
        };
        window.closeCountdownDialog = function () {
            const dialog = document.getElementById('countdownDialog');
            const overlay = document.getElementById('overlay');
            dialog.style.display = 'none';
            overlay.style.display = 'none';
            currentBossIndexForCountdown = null;
        };
        window.confirmCountdown = async function () {
            const countdownInput = document.getElementById('countdownInput');
            const minutes = parseInt(countdownInput.value, 10);
            if (currentBossIndexForCountdown !== null && minutes > 0) {
                const boss = bosses[currentBossIndexForCountdown];
                const now = new Date();
                // respawnTime = 現在時間 + 使用者輸入的分鐘數
                const respawnTime = new Date(now.getTime() + minutes * 60 * 1000);
                // killTime = respawnTime - boss預設respawnTime
                const killTime = new Date(respawnTime.getTime() - boss.respawnTime);

                await updateBossTimerByRespawn(currentBossIndexForCountdown, killTime, respawnTime);
            }
            closeCountdownDialog();
        };
        async function updateBossTimerByRespawn(bossIndex, killTime, respawnTime) {
            const boss = bosses[bossIndex];
            // 將事件存入Firebase
            const docRef = await addDoc(collection(db, 'bossEvents'), {
                bossName: boss.name,
                killTime: killTime.toISOString(),
                respawnTime: respawnTime.toISOString()
            });

            addToEventLog(boss.name, killTime, respawnTime, docRef.id);
            startTimer(bossIndex, killTime, respawnTime, docRef.id);
        }


        window.onload = async function () {
            generateCards();
            await loadEventsFromFirebase();
            updateEventLogHeight();
        };
    </script>
</head>

<body>
    <div id="eventLog">
        <div id="eventLogActions">
            <button onclick="copyAllEvents()">複製所有事件</button>
        </div>
        <div id="eventLogContent"></div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="搜尋Boss...">
    </div>
    <div class="page-title">
        <h1>哈娜RO Boss計時器</h1>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="input-time-dialog" id="timeDialog">
        <h3 id="dialogBossName"></h3>
        <input type="datetime-local" id="dialogTimeInput">
        <div class="dialog-buttons">
            <button onclick="confirmCustomTime()">確認</button>
            <button onclick="closeTimeDialog()">取消</button>
        </div>
    </div>
    <div class="input-time-dialog" id="countdownDialog">
        <h3 id="countdownDialogBossName"></h3>
        <label for="countdownInput">輸入距離重生的時間(分鐘):</label>
        <input type="number" id="countdownInput" min="1" value="30">
        <div class="dialog-buttons">
            <button onclick="confirmCountdown()">確認</button>
            <button onclick="closeCountdownDialog()">取消</button>
        </div>
    </div>

    <div class="container">
        <div class="mvp-section">
            <div class="category-title">MVP</div>
            <div class="cards-container">
                <!-- MVP卡片將在這裡生成 -->
            </div>
        </div>

        <div class="poring-section">
            <div class="category-title">波利家族</div>
            <div class="cards-container">
                <!-- 波利家族卡片將在這裡生成 -->
            </div>
        </div>
    </div>
</body>

</html>